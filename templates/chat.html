<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
	<title>감정 분석 채팅</title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
<div id="onboardingContainer" class="min-h-screen flex justify-center items-center">
	<div class="max-w-md w-full bg-white p-8 rounded shadow-lg">
		<h1 class="text-xl font-bold mb-4">채팅 참여</h1>
		<p id="error" class="text-red-500 mb-1 hidden">사용자 이름을 입력해주세요.</p>
		<input type="text" id="onboardingUsernameInput" placeholder="사용자 이름"
		       class="w-full mb-4 p-2 rounded border border-gray-300 focus:outline-none focus:ring focus:border-blue-500">
		<button id="createRoomButton" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">새 채팅방 만들기
		</button>
		<button id="joinRoomButton" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 mt-2">기존 채팅방에
			참여하기
		</button>
	</div>
</div>

<div id="roomListContainer" class="min-h-screen flex justify-center items-center">
	<div class="max-w-md w-full bg-white p-8 rounded shadow-lg">
		<h1 class="text-xl font-bold mb-4">채팅방 선택</h1>
		<ul id="roomList" class="mb-4"></ul>
		<button id="backButton" class="w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-600 mt-2">뒤로</button>
	</div>
</div>

<!--?수정은 여기 overflow hidden 을 제거-->
<div id="chatContainer" class="hidden flex h-screen w-full flex-col bg-gray-100 overflow-hidden">
	<header class="flex h-14 shrink-0 items-center justify-between border-b bg-white px-4">
		<div class="flex items-center gap-2">
			<div>
				이름:
				<input type="text" id="usernameInput" placeholder="유저 이름"
				       class="p-2 rounded-l border border-gray-300 " disabled>
			</div>
			<h1 id="room-name" class="pl-4 text-lg font-semibold">Chat Rooms</h1>
		</div>
	</header>
	<div class="flex h-full">
		<div class="hidden w-64 shrink-0 border-r bg-gray-50 p-4 md:block">
			<div class="mb-4 flex items-center justify-between">
				<h2 class="text-sm font-semibold">Active Rooms</h2>
				<button
					class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 w-10 rounded-full">
					+
				</button>
			</div>
			<div class="space-y-2">
				<a
					class="flex items-center gap-3 rounded-lg bg-white p-2 text-sm font-medium shadow-sm transition-colors hover:bg-gray-100"
					href="#"
				>
          <span class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full">
            <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">JP</span>
          </span>
					<div class="flex-1">
						<div class="line-clamp-1">General Chat</div>
						<div class="text-xs text-gray-500">12 active users</div>
					</div>
				</a>
				<a
					class="flex items-center gap-3 rounded-lg bg-white p-2 text-sm font-medium shadow-sm transition-colors hover:bg-gray-100"
					href="#"
				>
          <span class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full">
            <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">CN</span>
          </span>
					<div class="flex-1">
						<div class="line-clamp-1">Design Feedback</div>
						<div class="text-xs text-gray-500">8 active users</div>
					</div>
				</a>
				<a
					class="flex items-center gap-3 rounded-lg bg-white p-2 text-sm font-medium shadow-sm transition-colors hover:bg-gray-100"
					href="#"
				>
          <span class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full">
            <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">ML</span>
          </span>
					<div class="flex-1">
						<div class="line-clamp-1">Engineering Discussions</div>
						<div class="text-xs text-gray-500">15 active users</div>
					</div>
				</a>
			</div>
			<div class="mt-4 mb-2 text-sm font-semibold">Active Users</div>
			<div class="flex flex-wrap gap-2">
        <span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
          <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">JP</span>
        </span>
				<span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
          <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">CN</span>
        </span>
				<span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
          <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">ML</span>
        </span>
				<span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
          <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">SD</span>
        </span>
				<span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
          <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">TN</span>
        </span>
				<span class="relative flex shrink-0 overflow-hidden rounded-full w-8 h-8">
          <span class="flex h-full w-full items-center justify-center rounded-full bg-muted">LR</span>
        </span>
			</div>
		</div>
		<div class="flex-1">
			<div class="flex h-full flex-col">
				<!--?          여기 h를 h-full로 변경-->
				<div id="chatspace" class="overflow-y-scroll p-4 h-[80vh]">
					<div class="space-y-4">
					</div>
				</div>
				<!--?          여기 h를 h-16으로 변경-->
				<div class="flex h-[15vh] shrink-0 items-center border-t bg-white px-4">
					<input id="messageInput"
					       class="flex h-10 w-full border border-input ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 flex-1 rounded-lg bg-gray-100 px-4 py-2 text-sm focus:bg-white"
					       placeholder="Type your message..."
					       type="text"
					/>
					<button id="sendButton"
					        class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 w-10 ml-2 rounded-full">
						<img src="{{ url_for('static', path='/icons/message_send_icon.svg') }}" alt="message_send_icon">
					</button>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	const apiEndpoint = `${window.location.origin}/api/v1`;
	const socketEndpoint = apiEndpoint.replace('http', 'ws');

	const onboardingUsernameInput = document.getElementById('onboardingUsernameInput');
	const createRoomButton = document.getElementById('createRoomButton');
	const joinRoomButton = document.getElementById('joinRoomButton');
	const backButton = document.getElementById('backButton');
	const onboardingContainer = document.getElementById('onboardingContainer');
	const chatContainer = document.getElementById('chatContainer');
	const roomListContainer = document.getElementById('roomListContainer');
	const roomList = document.getElementById('roomList');
	const usernameInput = document.getElementById('usernameInput');
	const messages = document.getElementById('messages');
	const roomName = document.getElementById("room-name");

	let userName = `익명${(Math.random()).toString().substring(2, 6)}`;
	let ws = null;

	onboardingUsernameInput.value = userName;

	function setUserName(newUserName) {
		userName = newUserName;
	}

	function sendMessage() {
		const input = document.getElementById('messageInput');

		if (input.value) {
			const message = {
				username: userName,
				message: input.value
			};

			let messageJSON = JSON.stringify(message);
			ws.send(messageJSON);
			input.value = '';
		}
	}

	function createMessageElement(messageContent, timestamp) {
		const messageElement = document.createElement('div');
		messageElement.classList.add('flex', 'items-start', 'gap-3', 'justify-end', 'mt-5', 'mb-5');
		const messageLayout = document.createElement('div');
		messageLayout.classList.add('rounded-lg', 'bg-blue-500', 'p-3', 'text-white', 'shadow-sm');
		const messageContentElement = document.createElement('div');
		messageContentElement.textContent = messageContent;
		messageLayout.appendChild(messageContentElement);
		const timestampElement = document.createElement('div');
		timestampElement.textContent = timestamp;
		timestampElement.classList.add('mt-2', 'text-xs');
		messageLayout.appendChild(timestampElement);
		messageElement.appendChild(messageLayout);
		return messageElement;
	}

	function createOtherElement(name, message, timestamp) {
		const messageDiv = document.createElement('div');
		messageDiv.classList.add('flex', 'items-start', 'gap-3', 'mt-5', 'mb-5');
		const profileImageSpan = document.createElement('span');
		profileImageSpan.classList.add('relative', 'flex', 'h-10', 'w-10', 'overflow-hidden', 'rounded-full', 'shrink-0');
		const profileImage = document.createElement('span');
		profileImage.classList.add('flex', 'h-full', 'w-full', 'items-center', 'justify-center', 'rounded-full', 'bg-muted');
		profileImage.textContent = name.charAt(0); // 이름의 첫 글자를 프로필 이미지로 사용
		profileImageSpan.appendChild(profileImage);
		const messageContentDiv = document.createElement('div');
		messageContentDiv.classList.add('rounded-lg', 'bg-white', 'p-3', 'shadow-sm');
		const nameDiv = document.createElement('div');
		nameDiv.classList.add('font-medium');
		nameDiv.textContent = name;
		const messageDivInner = document.createElement('div');
		messageDivInner.classList.add('text-sm', 'text-gray-500');
		messageDivInner.textContent = message;
		const timestampDiv = document.createElement('div');
		timestampDiv.classList.add('mt-2', 'text-xs', 'text-gray-500');
		timestampDiv.textContent = timestamp;
		messageContentDiv.appendChild(nameDiv);
		messageContentDiv.appendChild(messageDivInner);
		messageContentDiv.appendChild(timestampDiv);
		messageDiv.appendChild(profileImageSpan);
		messageDiv.appendChild(messageContentDiv);
		return messageDiv;
	}

	function addMessage(name, messageContent, timestamp) {
		const messagesContainer = document.getElementById('chatspace');
		let messageElement;
		if (name === "System" || userName !== name)
			messageElement = createOtherElement(name, messageContent, timestamp)
		else
			messageElement = createMessageElement(messageContent, timestamp);
		messagesContainer.appendChild(messageElement);
		messagesContainer.scrollTop = messagesContainer.scrollHeight;
	}

	async function fetchChatRooms() {
		const response = await fetch(`${apiEndpoint}/chat/rooms`);
		return await response.json();
	}

	function renderChatRooms(rooms) {
		roomList.innerHTML = ''; // 기존 목록 초기화
		rooms.forEach(room => {
			const roomItemContainer = document.createElement('div');
			roomItemContainer.classList.add('border-b', 'border-gray-200');
			const roomItem = document.createElement('div');
			roomItem.classList.add('p-2', 'hover:bg-gray-200', 'cursor-pointer', 'flex');
			roomItem.addEventListener('click', function () {
				joinRoom(room.room_id);
			});

			const roomName = document.createElement('div');
			roomName.classList.add('flex-1');
			roomName.textContent = room.room_name;
			roomItem.appendChild(roomName);

			const roomUserCount = document.createElement('div');
			roomUserCount.classList.add('text-gray-500');
			roomUserCount.textContent = `${room.user_count}명`;
			roomItem.appendChild(roomUserCount);


			roomItemContainer.appendChild(roomItem);

			roomList.appendChild(roomItemContainer);
		});
	}

	async function joinRoom(roomId) {
		const username = document.getElementById('onboardingUsernameInput').value;
		usernameInput.value = username;

		if (!username) {
			alert('사용자 이름을 입력해주세요.');
			return;
		}

		onboardingContainer.classList.add('hidden');
		roomListContainer.classList.add('hidden');
		chatContainer.classList.remove('hidden');

		ws = new WebSocket(`${socketEndpoint}/chat/${roomId}/connect/${username}`);

		ws.onopen = function () {
			console.log("Connected to WebSocket server");
		};

		ws.onmessage = function (event) {
			const message = JSON.parse(event.data);
			if (message.username === "Root") {
				roomName.innerText = message.message
			} else {
				addMessage(message.username, message.message, new Date().toLocaleTimeString());
			}
		};

		ws.onclose = function () {
			console.log("WebSocket connection closed");
			ws = null;
		};

		ws.onerror = function (error) {
			console.error("WebSocket error:", error);
		};

		setUserName(username);
	}

	createRoomButton.addEventListener('click', async function () {
		const username = document.getElementById('onboardingUsernameInput').value;
		usernameInput.value = username;

		if (!username) {
			alert('사용자 이름을 입력해주세요.');
			return;
		}
		setUserName(username);

		onboardingContainer.classList.add('hidden');
		chatContainer.classList.remove('hidden');

		const response = await fetch(`${apiEndpoint}/chat/rooms/new`, {
			method: 'POST',
		})

		if (response.status >= 400) {
			alert('채팅방 생성에 실패했습니다.')
			return
		}

		const {room_id} = await response.json()
		await joinRoom(room_id)
	});

	joinRoomButton.addEventListener('click', async function () {
		onboardingContainer.classList.add('hidden');
		roomListContainer.classList.remove('hidden');

		usernameInput.value = document.getElementById('onboardingUsernameInput').value;

		const {chat_rooms} = await fetchChatRooms();
		renderChatRooms(chat_rooms);
	});

	backButton.addEventListener('click', function () {
		roomListContainer.classList.add('hidden');
		onboardingContainer.classList.remove('hidden');
	});

	document.getElementById('sendButton').addEventListener('click', sendMessage);

	document.getElementById('messageInput').addEventListener('keypress', function (event) {
		if (event.key === 'Enter') {
			sendMessage();
		}
	});
</script>
</body>
</html>
